version: 2.1

executors:
  skaffold:
    docker:
    - image: fractalfish/skaffold:b69a066a1079b5a48095e7f5d2b4653620baf2bf

orbs:
  docker: circleci/docker@0.5.20

jobs:
  build-skaffold:
    executor: docker/docker
    steps:
    - setup_remote_docker
    - checkout
    - docker/check
    - docker/build:
        image: fractalfish/skaffold
        dockerfile: docker/skaffold.Dockerfile
    - docker/push:
        image: fractalfish/skaffold
  deploy:
    executor: skaffold
    steps:
    - setup_remote_docker
    - checkout
    - run:
        name: Install Docker client
        command: apk add --no-cache docker-cli
    - run:
        name: Deploy images with Skaffold
        command: |
          echo $DOCKER_PASSWORD | docker login -u $DOCKER_LOGIN --password-stdin
          skaffold build -p push

workflows:
  commit:
    jobs:
    - build-skaffold
    - deploy
